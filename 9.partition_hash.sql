-- LIST HASH
DROP TABLE DEV.ORD_LIST_HASH PURGE;
CREATE TABLE DEV.ORD_LIST_HASH (
    ORD_NO              NUMBER (10)     NOT NULL
  , ORD_YM              VARCHAR2 (6)    NOT NULL
  , ORD_DT              VARCHAR2 (8)
  , ORD_HMS             VARCHAR2 (6)
  , SHOP_NO             VARCHAR2 (10)
  , UPPER2              VARCHAR2 (2)
  , UPPER_CASE          VARCHAR2 (10)
  , LOWER_CASE          VARCHAR2 (10)
  , ALPHABET            VARCHAR2 (400)
  , ALPHABET_NUMERIC    VARCHAR2 (400)
)
PARTITION BY LIST (ORD_YM) 
SUBPARTITION BY HASH(ORD_NO) SUBPARTITIONS 8
(
    PARTITION P201201 VALUES ('201201'),
    PARTITION P201202 VALUES ('201202'),
    PARTITION P201203 VALUES ('201203'),
    PARTITION P201204 VALUES ('201204'),
    PARTITION P201205 VALUES ('201205'),
    PARTITION P201206 VALUES ('201206'),
    PARTITION P201207 VALUES ('201207'),
    PARTITION P201208 VALUES ('201208'),
    PARTITION P201209 VALUES ('201209'),
    PARTITION P201210 VALUES ('201210'),
    PARTITION P201211 VALUES ('201211'),
    PARTITION P201212 VALUES ('201212'),

    PARTITION P201301 VALUES ('201301'),
    PARTITION P201302 VALUES ('201302'),
    PARTITION P201303 VALUES ('201303'),
    PARTITION P201304 VALUES ('201304'),
    PARTITION P201305 VALUES ('201305'),
    PARTITION P201306 VALUES ('201306'),
    PARTITION P201307 VALUES ('201307'),
    PARTITION P201308 VALUES ('201308'),
    PARTITION P201309 VALUES ('201309'),
    PARTITION P201310 VALUES ('201310'),
    PARTITION P201311 VALUES ('201311'),
    PARTITION P201312 VALUES ('201312'),
    
    PARTITION P_DEFAULT VALUES (DEFAULT)
);

ALTER TABLE DEV.ORD_LIST_HASH NOLOGGING;



DROP TABLE DEV.ORD_ITEM_LIST_HASH PURGE;
CREATE TABLE DEV.ORD_ITEM_LIST_HASH (
    ORD_NO              NUMBER (10)     NOT NULL
  , ITEM_ID             NUMBER (10)     NOT NULL
  , ORD_ITEM_QTY        NUMBER (4)
  , ORD_YM              VARCHAR2 (6)    NOT NULL
  , ORD_DT              VARCHAR2 (8)
  , ORD_HMS             VARCHAR2 (6)
  , UPPER2              VARCHAR2 (2)
  , UPPER_CASE          VARCHAR2 (10)
  , LOWER_CASE          VARCHAR2 (10)
  , ALPHABET            VARCHAR2 (400)
  , ALPHABET_NUMERIC    VARCHAR2 (400)
)
PARTITION BY LIST (ORD_YM) 
SUBPARTITION BY HASH(ORD_NO) SUBPARTITIONS 8
(
    PARTITION P201201 VALUES ('201201'),
    PARTITION P201202 VALUES ('201202'),
    PARTITION P201203 VALUES ('201203'),
    PARTITION P201204 VALUES ('201204'),
    PARTITION P201205 VALUES ('201205'),
    PARTITION P201206 VALUES ('201206'),
    PARTITION P201207 VALUES ('201207'),
    PARTITION P201208 VALUES ('201208'),
    PARTITION P201209 VALUES ('201209'),
    PARTITION P201210 VALUES ('201210'),
    PARTITION P201211 VALUES ('201211'),
    PARTITION P201212 VALUES ('201212'),

    PARTITION P201301 VALUES ('201301'),
    PARTITION P201302 VALUES ('201302'),
    PARTITION P201303 VALUES ('201303'),
    PARTITION P201304 VALUES ('201304'),
    PARTITION P201305 VALUES ('201305'),
    PARTITION P201306 VALUES ('201306'),
    PARTITION P201307 VALUES ('201307'),
    PARTITION P201308 VALUES ('201308'),
    PARTITION P201309 VALUES ('201309'),
    PARTITION P201310 VALUES ('201310'),
    PARTITION P201311 VALUES ('201311'),
    PARTITION P201312 VALUES ('201312'),
    
    PARTITION P_DEFAULT VALUES (DEFAULT)
);

ALTER TABLE DEV.ORD_ITEM_LIST_HASH NOLOGGING;



INSERT  /*+ APPEND PARALLEL(ORL 4) */ INTO DEV.ORD_LIST_HASH ORL
SELECT  /*+ FULL(O) PARALLEL(O 4) */
        ORD_NO
      , SUBSTR(ORD_DT,1,6) ORD_YM
      , ORD_DT
      , ORD_HMS
      , SHOP_NO
      , UPPER2
      , UPPER_CASE
      , LOWER_CASE
      , ALPHABET
      , ALPHABET_NUMERIC
FROM    DEV.ORD_LIST    O
;

COMMIT;

INSERT  /*+ APPEND PARALLEL(OIL 4) */ INTO DEV.ORD_ITEM_LIST_HASH OIL
SELECT  /*+ FULL(OI) PARALLEL(OI 4) */
        ORD_NO
      , ITEM_ID
      , ORD_ITEM_QTY
      , SUBSTR(ORD_DT,1,6) ORD_YM
      , ORD_DT
      , ORD_HMS
      , UPPER2
      , UPPER_CASE
      , LOWER_CASE
      , ALPHABET
      , ALPHABET_NUMERIC
FROM    DEV.ORD_ITEM_LIST    OI
;

COMMIT;

-- PK 및 인덱스 생성
-- ORD
CREATE UNIQUE INDEX DEV.ORD_LIST_HASH_PK ON DEV.ORD_LIST_HASH(ORD_NO, ORD_YM) LOCAL PARALLEL 8;
ALTER INDEX DEV.ORD_LIST_HASH_PK NOPARALLEL;
ALTER TABLE DEV.ORD_LIST_HASH ADD CONSTRAINT ORD_LIST_HASH_PK PRIMARY KEY (ORD_NO, ORD_YM) USING INDEX DEV.ORD_LIST_HASH_PK;

CREATE INDEX DEV.ORD_LIST_HASH_X01 ON DEV.ORD_LIST_HASH(ORD_DT, ORD_HMS) LOCAL PARALLEL 8;
ALTER INDEX DEV.ORD_LIST_HASH_X01 NOPARALLEL;


-- ORD_ITEM
CREATE UNIQUE INDEX DEV.ORD_ITEM_LIST_HASH_PK ON DEV.ORD_ITEM_LIST_HASH(ORD_NO, ITEM_ID, ORD_YM) LOCAL PARALLEL 8;
ALTER INDEX DEV.ORD_ITEM_LIST_HASH_PK NOPARALLEL;
ALTER TABLE DEV.ORD_ITEM_LIST_HASH ADD CONSTRAINT ORD_ITEM_LIST_HASH_PK PRIMARY KEY (ORD_NO, ITEM_ID, ORD_YM) USING INDEX DEV.ORD_ITEM_LIST_HASH_PK;

CREATE INDEX DEV.ORD_ITEM_LIST_HASH_X01 ON DEV.ORD_ITEM_LIST_HASH(ORD_DT, ORD_HMS) LOCAL PARALLEL 8;
ALTER INDEX DEV.ORD_ITEM_LIST_HASH_X01 NOPARALLEL;


